---
title: "Assessing soil fauna activity from in-situ imaging: influence of image capture resolution and frequency"
format:
  html:
    css: css/styles.css  
    embed-resources: true
    code-tools: true
    
execute: 
  warning: false
  message: false
  echo: false
---

This study investigates the influence of image capture resolution and frequency on the assessment of soil fauna activity. Three taxonomic groups were targeted: Enchytraeidae, Acari, and Collembola. Eight combinations of resolution and frequency were tested under controlled laboratory conditions.

## Materiel and method

**Experimental Setup** / Three plastic soil microcosms (40 × 40 × 20 cm) were placed in a greenhouse to allow controlled access and protection from rainfall. Opaque covers minimized light penetration, reproducing field-like conditions. Soil was collected from an experimental agroforestry site (DIAMS, Mauguio, France), sieved (2 cm and 2 mm) and positioned against scanner glass to standardize image composition. Vegetation was removed to ensure homogeneous soil composition.

Three Epson Perfection V39 scanners were angled at 45° to prevent soil displacement during irrigation. Each microcosm included temperature and moisture probes to monitor and maintain suitable conditions. Scanners were automated to capture images at predefined resolutions and frequencies.

**Capture Parameters**

-   Resolutions: 600 dpi (minimum for smallest organisms), 1200 dpi (intermediate), 2400 dpi (maximum manageable file size).

-   Frequencies: 15 min, 1 h, 6 h. Due to scanning duration, the 2400 dpi × 15 min combination was not feasible.

Eight combinations were tested: 600 dpi × 15 min, 1 h, 6 h; 1200 dpi × 15 min, 1 h, 6 h; 2400 dpi × 1 h, 6 h.

**Data collection** / Twelve images per combination per microcosm were captured to ensure balanced data. Low-frequency combinations required multiple days, while high-frequency combinations completed within hours. Three microcosms served as pseudo-replicates. Each combination was tested at different times of day to minimize diurnal effects. The cycle was repeated four times.

Images were analyzed with an automated invertebrate detection tool developed at UMR Eco&Sols using RStudio. The software segmented images into sub-images to detect moving objects, including soil fauna. High-resolution images (2400 dpi) were split into four sub-images for processing, resulting in 48 images per series.

Detected invertebrates were classified at the class or order level using an RStudio annotation script, producing structured datasets for statistical analysis.

## Results

A total of 852 tray images were analyzed. Automated image analysis extracted 66,415 sub-images, of which 57,519 (87%) contained no objects and were removed. Sub-images containing non-faunal objects (roots, organic matter) were excluded (1,852, 3%), as well as 542 (1%) unknown objects. Finally, 6,293 sub-images (9%) contained identifiable soil fauna and were retained for analysis.

```{r}
# Load packages
library(tidyverse)
library(forcats)
library(scales)
library(lme4)
library(emmeans)
library(MASS)

# Load full dataset
data <- read.csv("../data/database_calibration.csv") %>% drop_na()
```

```{r}
# Clean and group taxa 
clean_taxa <- function(df) {
  df %>%
    filter(!class %in% c("NA", "root", "SOM", "unknown", "unclassified")) %>%
    mutate(
      group = case_when(
        class %in% c("collembola", "poduromorpha") ~ "Collembola",
        class %in% c("acari", "oribatida", "trombidiforme", "mesostigmata") ~ "Acari",
        class == "enchytraeidae" ~ "Enchytraeidae",
        TRUE ~ class
      ),
      combination = paste(frequence, resolution, sep="_")
    )
}

data_clean <- clean_taxa(data)
```

```{r}
# Count by group / combination 
count_by_group <- function(df) {
  df %>%
    group_by(group, combination) %>%
    summarise(n = n(), .groups="drop")
}

count_data <- count_by_group(data_clean)

# General barplots by group
colors_taxa <- c("Collembola"="#1f77b4","Acari"="#ff7f0e","Enchytraeidae"="#2ca02c",
                 "Lumbricidae"="grey","Isopoda"="grey","Julida"="grey",
                 "Gastropoda"="grey","Formicidae"="grey")

ggplot(count_data, aes(x=n, y=fct_reorder(group,n), fill=group)) +
  geom_bar(stat="identity") +
  scale_fill_manual(values=colors_taxa) +
  labs(#title="Taxonomic distribution of detected fauna", 
       x="Occurrences", y="Taxa") +
  theme_minimal(base_size = 10) +
  theme(legend.position="none",
        plot.title=element_text(hjust=0.5, face="bold"))
```

Three major groups were retained for further analysis: Enchytraeidae (\~8,000 detections), Acari (\~1,100), and Collembola (\~600). Enchytraeidae dominate detections, highlighting their relative abundance and detectability under these experimental conditions.

### Effect of capture resolution and frequency on overall fauna detection

```{r}
# Summarize total organisms per image (all taxa combined)

data_total <- data_clean %>%
group_by(initial_image_name, resolution, frequence, bac) %>%
summarise(n_total = n(), .groups="drop")

# Box-Cox transformation to ensure normality

# Add 1 to avoid zeros
bc_model <- lm(n_total + 1 ~ resolution * frequence, data = data_total)
bc <- boxcox(bc_model, lambda = seq(-2, 2, 0.1), plotit = FALSE)
lambda_opt <- bc$x[which.max(bc$y)]

# Apply transformation
if(abs(lambda_opt) < 1e-3){
data_total <- data_total %>% mutate(n_trans = log(n_total + 1))
} else {
data_total <- data_total %>% mutate(n_trans = ((n_total + 1)^lambda_opt - 1)/lambda_opt)
}

# Fit mixed model with transformed response
model_total <- lmer(n_trans ~ resolution*frequence + (1|bac), data = data_total)
emm_total <- emmeans(model_total, ~resolution*frequence)

# Back-transform predictions for plotting
df_total <- as.data.frame(emm_total)
if(abs(lambda_opt) < 1e-3){
  df_total <- df_total %>%
    mutate(
      pred = exp(emmean),
      lower = exp(lower.CL),
      upper = exp(upper.CL)
    )
} else {
  df_total <- df_total %>%
    mutate(
      pred = ((lambda_opt * emmean) + 1)^(1 / lambda_opt),
      lower = ((lambda_opt * lower.CL) + 1)^(1 / lambda_opt),
      upper = ((lambda_opt * upper.CL) + 1)^(1 / lambda_opt)
    )
}

# Plot predictions
pd <- position_dodge(width=0.4)
ggplot(df_total %>% mutate(
    resolution = fct_relevel(resolution, "600dpi"),
    frequence = fct_relevel(frequence, "15min")
  ), aes(x=resolution, y=pred, color=frequence, group=frequence)) +
geom_point(position=pd, size=3) +
geom_errorbar(aes(ymin=lower, ymax=upper), width=0.2, position=pd) +
scale_y_continuous(limits=c(0, NA)) +
labs(title="Predicted total soil fauna per image by resolution and frequency",
x="Resolution",
y="Predicted number of organisms",
color="Capture frequency") +
theme_minimal(base_size=10)

```

-   At 600 dpi, capture frequency did not significantly affect organism counts.

-   At 1200 dpi, increasing frequency from 15 min to 6 h increased detections by \~5 organisms per image (p \< 0.05). 1200 dpi generally detected more organisms than 600 dpi for 1 h and 6 h frequencies.

-   At 2400 dpi, the 6 h frequency captured the highest number of organisms (\~25 per image).

Higher resolution and moderate-to-long intervals between captures improve overall detection. Extremely high frequency at high resolution may not further increase detectability due to behavioral avoidance and technical limitations.

### Distribution of taxonomic groups across resolution and frequency

```{r}
# Pie chart per condition
df_pie <- data_clean %>%
  filter(group %in% c("Collembola","Acari","Enchytraeidae")) %>%
  group_by(resolution, frequence, group) %>%
  summarise(n = n(), .groups="drop") %>%
  group_by(resolution, frequence) %>%
  mutate(proportion = n / sum(n),
         total_n = sum(n),
         condition = paste(resolution, frequence, sep=" - "),
         alpha_val = rescale(total_n, to=c(0.7,1))) %>%
  ungroup() %>%
  mutate(condition = factor(condition, levels = c(
    "600dpi - 15min","600dpi - 1h","600dpi - 6h",
    "1200dpi - 15min","1200dpi - 1h","1200dpi - 6h",
    "2400dpi - 1h","2400dpi - 6h"
  )))

ggplot(df_pie, aes(x="", y=proportion, fill=group)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y") +
  facet_wrap(~condition) +
  labs(title="Taxonomic group distribution by resolution and frequency", fill="Group") +
  scale_fill_manual(values=c("Collembola"="#1f77b4","Acari"="#ff7f0e","Enchytraeidae"="#2ca02c")) +
  theme_bw() +
  theme(axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank(),
        panel.grid=element_blank(),
        strip.text=element_text(size=12))
```

-   Enchytraeidae were abundant across all modalities, with the maximum at 2400 dpi × 6 h (1,859 detections).

-   Collembola were rarely detected at 600 dpi (4 detections) but increasingly at 1200 dpi (40–82) and 2400 dpi (182–251).

-   Acari detections similarly increased with resolution: 10–11 at 600 dpi, 83–122 at 1200 dpi, and 251–325 at 2400 dpi.

Resolution critically affects detection of smaller taxa. Low-resolution scans fail to capture Collembola and Acari effectively.

```{r}
# Mixed models per taxon
run_mixed_model <- function(df, taxon){
  df_sub <- filter(df, group==taxon) %>%
    group_by(initial_image_name, resolution, frequence, bac) %>%
    summarise(n_objects = n(), .groups="drop")
  
  model <- lmer(n_objects ~ resolution*frequence + (1|bac), data=df_sub)
  emmeans(model, ~resolution*frequence)
}

taxa_list <- c("Collembola","Acari","Enchytraeidae")
emm_list <- lapply(taxa_list, function(t) run_mixed_model(data_clean,t))
names(emm_list) <- taxa_list
```

```{r}
# Plot predictions
pd <- position_dodge(width=0.4)
plot_list <- list()  # liste vide pour stocker les graphiques

for(taxon in taxa_list){
  df <- as.data.frame(emm_list[[taxon]])
  df$resolution <- factor(df$resolution, levels=c("600dpi","1200dpi","2400dpi"))
  
  p <- ggplot(df, aes(x=resolution, y=emmean, color=frequence, group=frequence)) +
    geom_point(position=pd, size=3) +
    geom_errorbar(aes(ymin=emmean-SE, ymax=emmean+SE), width=0.2, position=pd) +
    labs(title=paste("Predicted number of", taxon, "by resolution and frequency"),
         x="Resolution", 
         y="Predicted number of organisms", 
         color="Frequency") +
    theme_minimal(base_size=10)
  
  plot_list[[taxon]] <- p  # stocke le graphique dans la liste
}
```

### Enchytraeidae detection per image

```{r}
plot_list$Enchytraeidae
```

-   600 dpi: higher counts at 1 h and 6 h than 15 min (p \< 0.05).

-   1200 dpi x 6 h frequency produced the highest counts (\~17 per image).

-   2400 dpi: 6 h frequency slightly decreased counts compared to 1200 dpi.

Enchytraeidae may respond to repeated short-interval light exposure (lucifuge behavior), reducing detection at high-frequency captures. Longer intervals allow individuals to re-enter the scanned area.

### Collembola detection per image

```{r}
plot_list$Collembola
```

-   1200 dpi did not significantly increase detections over 600 dpi for any frequency.

-   2400 dpi increased detections \>2 per image at 1 h and \>3 per image at 6 h.

-   Maximum detection at 2400 dpi × 6 h (p \< 0.05).

Small size and light-sensitive behavior make Collembola detection highly dependent on resolution and less frequent imaging.

### Acari detection per image

```{r}
plot_list$Acari
```

-   600 dpi: frequency had no effect.

-   1200 dpi: 1 h and 6 h increased detections (2 per image).

-   2400 dpi: 1 h and 6 h detected 3–4 individuals per image.

High resolution is essential for detecting Acari (\<1 mm). Short-interval captures may reduce detection due to disturbance or light avoidance.

## Discussion

The study shows that both the resolution and frequency of image capture significantly affect the detection of soil fauna. Small taxa such as Acari and Collembola require a resolution of at least 1200 dpi for reliable detection, with 2400 dpi providing maximal detection, though this comes with increased file sizes and longer scanning times. Regarding capture frequency, intermediate to low frequencies of 1–6 hours are more effective than very high frequencies of 15 minutes, particularly for light-sensitive or disturbance-sensitive taxa. Responses also vary by taxon: Enchytraeidae are abundant and detectable across all resolutions, but their counts may decrease with high-frequency scanning, whereas the detection of Acari and Collembola is highly sensitive to both resolution and capture interval. These findings highligths the methodological trade-offs in long-term monitoring, balancing detection efficiency against technical limitations such as file size, scan duration, and potential disturbance. **A setting of 1200 dpi with 6-hour intervals offers an optimal compromise, ensuring effective detection, minimizing stress on organisms, and maintaining operational feasibility, making it the preferred choice for extended monitoring campaigns and comparative studies of soil fauna activity**.

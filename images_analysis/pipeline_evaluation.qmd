---
title: "pipeline evaluation : data from "In situ soil imaging, a tool for monitoring the hourly to monthly temporal dynamics of soil biota""
format:
  html:
    css: css/styles.css  
    embed-resources: true
    code-tools: true
    
execute: 
  warning: false
  message: false
  echo: false
---

```{r}
library(tidyverse)
library(stringr)
```

```{r}
# 1. Automated Data Preparation
# Extracting timestamps from Basename and cleaning class names
automated_clean <- read.csv("../images_analysis/classification_TRUF.csv") %>%
  mutate(
    extracted_date = str_extract(Basename, "\\d{6}-\\d{4}"),
    year  = 2000 + as.numeric(substr(extracted_date, 1, 2)),
    month = as.numeric(substr(extracted_date, 3, 4)),
    day   = as.numeric(substr(extracted_date, 5, 6)),
    hour  = as.numeric(substr(extracted_date, 8, 9)),
    class = tolower(trimws(Predicted.class))
  ) %>%
  filter(class != "") %>%
  group_by(Basename, year, month, day, hour, class) %>%
  summarise(automated_count = n(), .groups = 'drop')

# 2. Manual Data Preparation
# Cleaning class names and aggregating counts per hour/class
manual_clean <- read.csv("../images_analysis/invertebrates_activity.csv", sep = ";") %>%
  mutate(
    year  = as.numeric(year),
    month = as.numeric(month),
    day   = as.numeric(day),
    hour  = as.numeric(hour),
    class = tolower(trimws(subject))
  ) %>%
  group_by(year, month, day, hour, class) %>%
  summarise(manual_count = sum(subjects_number, na.rm = TRUE), .groups = 'drop')

# 3. Merging and Pivot to Long Format
# We use a full_join to align both methods by time and class, then pivot for analysis
comparison_data <- full_join(automated_clean, manual_clean, 
                             by = c("year", "month", "day", "hour", "class")) %>%
  # Fill missing Basenames for manual records using the matching timestamp
  group_by(year, month, day, hour) %>%
  fill(Basename, .direction = "downup") %>%
  ungroup() %>%
  # Pivot counts into a single column
  pivot_longer(
    cols = c(automated_count, manual_count),
    names_to = "method",
    values_to = "count"
  ) %>%
  mutate(
    method = str_remove(method, "_count"),
    count  = replace_na(count, 0)
  ) %>%
  select(Basename, year, month, day, hour, class, method, count)
```

```{r}
# Define threshold and Top Taxa
threshold <- 20

# Identify the top 12 taxa by total abundance to use for the Correlation Plot
top_taxa <- comparison_data %>%
  group_by(class) %>%
  summarise(total = sum(count, na.rm = TRUE)) %>%
  slice_max(total, n = 12) %>%
  pull(class)

# Prepare the data for correlation (Wide Format)
# We calculate total_class_count here so it's available for filtering
correlation_data <- comparison_data %>%
  group_by(class) %>%
  mutate(total_class_count = sum(count)) %>%
  ungroup() %>%
  pivot_wider(names_from = method, values_from = count, values_fill = 0)

ggplot(correlation_data %>% filter(class %in% top_taxa), 
       aes(x = manual, y = automated)) +
  geom_point(alpha = 0.4, color = "#4DAF4A") +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "grey50") + 
  geom_smooth(method = "lm", color = "blue", se = FALSE, size = 0.8) + 
  facet_wrap(~class, scales = "free") +
  theme_minimal() +
  labs(
    title = "Detection Accuracy: Manual vs. Automated",
    subtitle = "Dashed line represents 1:1 agreement; Blue line is the linear trend",
    x = "Manual Count (Ground Truth)",
    y = "Automated Count (AI Prediction)"
  )

```
